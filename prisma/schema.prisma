datasource db {
  provider = "postgresql"
  url = env("POSTGRES_PRISMA_URL") // Uses connection pooling
  directUrl = env("POSTGRES_URL_NON_POOLING") // Uses a direct connection
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  password  String
  role      String   @default("EMPLOYEE") // "EMPLOYEE", "MANAGER", "ADMIN"
  isActive  Boolean  @default(false)
  
  positionId String?
  position   Position? @relation(fields: [positionId], references: [id])
  
  locationId String?
  location   Location? @relation(fields: [locationId], references: [id])
  
  regionId   String?
  region     Region?   @relation(fields: [regionId], references: [id])

  managerId String?
  manager   User?    @relation("UserManager", fields: [managerId], references: [id])
  subordinates User[] @relation("UserManager")
  
  requests  Request[]
  approvals Approval[]
  
  delegatedTo   Delegation[] @relation("DelegatedTo")
  delegatedBy   Delegation[] @relation("DelegatedBy")
  notifications Notification[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Request {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  type          String   // "ONSITE", "OFFSITE"
  startDate     DateTime
  endDate       DateTime
  reason        String
  justification String?  // Optional: Required when duration exceeds limit
  status        String   @default("PENDING") // "PENDING", "APPROVED", "REJECTED"
  createdAt     DateTime @default(now())
  
  approvals   Approval[]
  delegation  Delegation?
}

model Approval {
  id        String   @id @default(cuid())
  requestId String
  request   Request  @relation(fields: [requestId], references: [id])
  approverId String
  approver  User     @relation(fields: [approverId], references: [id])
  status    String   // "APPROVED", "REJECTED"
  comment   String?
  createdAt DateTime @default(now())
}

model Location {
  id        String   @id @default(cuid())
  name      String
  address   String?
  regionId  String?
  region    Region?  @relation(fields: [regionId], references: [id])
  users     User[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Region {
  id        String   @id @default(cuid())
  name      String
  locations Location[]
  users     User[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Position {
  id          String   @id @default(cuid())
  name        String
  description String?
  users       User[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Setting {
  id                String   @id @default(cuid())
  key               String   @unique
  value             String
  description       String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Delegation {
  id              String   @id @default(cuid())
  requestId       String   @unique
  request         Request  @relation(fields: [requestId], references: [id])
  delegateUserId  String
  delegateUser    User     @relation("DelegatedTo", fields: [delegateUserId], references: [id])
  delegatorUserId String
  delegatorUser   User     @relation("DelegatedBy", fields: [delegatorUserId], references: [id])
  reason          String?
  status          String   @default("PENDING") // "PENDING", "ACCEPTED", "REJECTED"
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Notification {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  type        String   // "DURATION_EXCEEDED", "DELEGATION_REQUEST", "APPROVAL_NEEDED"
  title       String
  message     String
  relatedId   String?  // ID of related request/delegation
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())
}
